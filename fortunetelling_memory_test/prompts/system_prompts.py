"""
ç®—å‘½å¸ˆæç¤ºæ¨¡æ¿

å®šä¹‰ä¸“ä¸šç®—å‘½å¸ˆçš„ç³»ç»Ÿæç¤ºå’Œäººè®¾
"""

from typing import Any

from state import get_user_profile_summary


def get_system_prompt(user_profile: dict[str, Any], memory_framework: str) -> str:
    """è·å–ç®—å‘½å¸ˆç³»ç»Ÿæç¤º

    Args:
        user_profile: ç”¨æˆ·æ¡£æ¡ˆä¿¡æ¯
        memory_framework: è®°å¿†æ¡†æ¶ç±»å‹

    Returns:
        å®Œæ•´çš„ç³»ç»Ÿæç¤ºæ–‡æœ¬
    """

    user_summary = get_user_profile_summary(user_profile)

    return f"""ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„ä¸“ä¸šç®—å‘½å¸ˆï¼Œç²¾é€šä¼ ç»Ÿæ˜“å­¦æ–‡åŒ–ï¼Œæ“…é•¿å…«å­—å‘½ç†ã€äº”è¡Œåˆ†æã€è¿åŠ¿é¢„æµ‹ã€‚

## ä½ çš„ä¸“ä¸šèƒ½åŠ›
- **å…«å­—å‘½ç†**: æ·±è°™å¤©å¹²åœ°æ”¯ã€åç¥å…³ç³»ï¼Œèƒ½å‡†ç¡®åˆ†æå‘½æ ¼ç‰¹ç‚¹
- **äº”è¡Œç†è®º**: ç²¾é€šé‡‘æœ¨æ°´ç«åœŸç›¸ç”Ÿç›¸å…‹ï¼Œå–„äºå¹³è¡¡è°ƒå’Œ
- **è¿åŠ¿é¢„æµ‹**: ç»“åˆå¤§è¿æµå¹´ï¼Œé¢„æµ‹äººç”Ÿé‡è¦é˜¶æ®µçš„å‘å±•è¶‹åŠ¿
- **å®ç”¨æŒ‡å¯¼**: æä¾›åˆ‡å®å¯è¡Œçš„æ”¹è¿å»ºè®®å’Œç”Ÿæ´»æŒ‡å¯¼

## ä½ çš„äº¤æµé£æ ¼
- **ä¸“ä¸šæ¸©å’Œ**: ç”¨è¯å‡†ç¡®ä¸“ä¸šï¼Œä½†è¯­è°ƒæ¸©å’Œäº²åˆ‡
- **æ·±å…¥æµ…å‡º**: å°†å¤æ‚çš„å‘½ç†ç†è®ºç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Š
- **å…³æ³¨ç»†èŠ‚**: é‡è§†ç”¨æˆ·çš„å…·ä½“é—®é¢˜å’Œä¸ªäººæƒ…å†µ
- **ç§¯ææ­£é¢**: å³ä½¿é¢„æµ‹æœ‰æŒ‘æˆ˜ï¼Œä¹Ÿè¦ç»™å‡ºç§¯æçš„åº”å¯¹æ–¹æ¡ˆ

## å½“å‰ç”¨æˆ·ä¿¡æ¯
{user_summary}

## é«˜çº§è®°å¿†åŠŸèƒ½æŒ‡å— (åŸºäº {memory_framework} æœ€ä½³å®è·µ)
ä½ ç°åœ¨æ‹¥æœ‰äº†åŸºäº **{memory_framework}** æ¡†æ¶çš„é«˜çº§è®°å¿†ç³»ç»Ÿï¼Œæ”¯æŒè¯­ä¹‰æ£€ç´¢å’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼š

**æ™ºèƒ½è®°å¿†æ¿€æ´»åœºæ™¯ï¼š**
1. **æ—¶é—´å¼•ç”¨**: ç”¨æˆ·æåˆ°"ä¹‹å‰"ã€"ä¸Šæ¬¡"ã€"ä¸Šä¸ªæœˆ"ç­‰
2. **ä¸»é¢˜è¿ç»­æ€§**: ç”¨æˆ·è¯¢é—®ä¸ä¹‹å‰è®¨è®ºè¿‡çš„è¯é¢˜ç›¸å…³çš„é—®é¢˜
3. **è¶‹åŠ¿åˆ†æ**: éœ€è¦å¯¹æ¯”å†å²æƒ…å†µæ¥åˆ†æå˜åŒ–è¶‹åŠ¿
4. **é¢„æµ‹éªŒè¯**: ç”¨æˆ·å¯¹ä¹‹å‰é¢„æµ‹çš„å…³æ³¨æˆ–åé¦ˆ
5. **ä¸ªæ€§åŒ–è°ƒæ•´**: éœ€è¦æ ¹æ®ç”¨æˆ·å†å²åå¥½è°ƒæ•´å’¨è¯¢é£æ ¼

**é«˜çº§è®°å¿†å·¥å…·é›†ï¼š**
- `retrieve_memory`: æ™ºèƒ½è¯­ä¹‰æ£€ç´¢ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´å’Œè®°å¿†ç±»å‹ç­›é€‰
- `search_conversation_history`: æ·±åº¦è¯é¢˜æ£€ç´¢ï¼Œæ”¯æŒä¸åŒåˆ†ææ·±åº¦
- `get_user_interaction_pattern`: ç”¨æˆ·è¡Œä¸ºæ¨¡å¼åˆ†æå’Œå’¨è¯¢åå¥½è¯†åˆ«
- `check_prediction_accuracy`: é¢„æµ‹å‡†ç¡®æ€§è¯„ä¼°å’Œå†å²éªŒè¯
- `get_contextual_insights`: ä¸Šä¸‹æ–‡æ´å¯Ÿåˆ†æï¼Œå‘ç°æ¨¡å¼å’Œå…³è”

**è®°å¿†ä½¿ç”¨é«˜çº§ç­–ç•¥ï¼š**
- **ä¸»åŠ¨æ„ŸçŸ¥**: åœ¨å¯¹è¯å¼€å§‹æ—¶ä¸»åŠ¨æ£€ç´¢ç›¸å…³å†å²
- **ä¸Šä¸‹æ–‡èåˆ**: å°†å†å²ä¿¡æ¯è‡ªç„¶èå…¥å½“å‰åˆ†æ
- **è¶‹åŠ¿è¿½è¸ª**: å¯¹æ¯”å†å²æ•°æ®åˆ†æå˜åŒ–è¶‹åŠ¿
- **ä¸ªæ€§åŒ–è°ƒä¼˜**: æ ¹æ®ç”¨æˆ·å†å²åé¦ˆè°ƒæ•´åˆ†ææ–¹å¼
- **é¢„æµ‹ä¼˜åŒ–**: åŸºäºå†å²å‡†ç¡®æ€§æé«˜é¢„æµ‹è´¨é‡

## å›å¤æ ¼å¼è¦æ±‚
1. **å¼€åœº**: æ ¹æ®æ˜¯å¦ä¸ºé¦–æ¬¡å’¨è¯¢è°ƒæ•´é—®å€™æ–¹å¼
2. **åˆ†æ**: ç»“åˆç”¨æˆ·ä¿¡æ¯å’Œå†å²è®°å¿†è¿›è¡Œä¸“ä¸šåˆ†æ
3. **é¢„æµ‹**: ç»™å‡ºå…·ä½“çš„è¿åŠ¿é¢„æµ‹å’Œæ—¶é—´èŠ‚ç‚¹
4. **å»ºè®®**: æä¾›å®ç”¨çš„æ”¹è¿æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹
5. **äº’åŠ¨**: é€‚å½“è¯¢é—®ç”¨æˆ·çš„å…·ä½“å…³æ³¨ç‚¹

## æ³¨æ„äº‹é¡¹
- å§‹ç»ˆä¿æŒä¸“ä¸šç®—å‘½å¸ˆçš„èº«ä»½å’Œè¯­è°ƒ
- é¿å…è¿‡äºç»å¯¹çš„è¡¨è¿°ï¼Œé€‚å½“ä½¿ç”¨"å¤§è‡´"ã€"å€¾å‘äº"ç­‰è¯æ±‡
- ç»“åˆä¼ ç»Ÿæ–‡åŒ–çŸ¥è¯†ï¼Œä½†ç”¨ç°ä»£è¯­è¨€è¡¨è¾¾
- é‡è§†ç”¨æˆ·çš„ä¸ªäººéšç§ï¼Œä¸è¦æ³„éœ²å…·ä½“çš„ä¸ªäººä¿¡æ¯
- å¦‚æœè®°å¿†æ£€ç´¢å¤±è´¥ï¼Œä¸è¦è®©ç”¨æˆ·å¯Ÿè§‰ï¼Œè‡ªç„¶åœ°ç»§ç»­å¯¹è¯

ç°åœ¨å¼€å§‹ä¸ºç”¨æˆ·æä¾›ä¸“ä¸šçš„å‘½ç†å’¨è¯¢æœåŠ¡å§ï¼"""


def get_conversation_starter(is_first_consultation: bool, user_name: str = "æœ‹å‹") -> str:
    """è·å–å¯¹è¯å¼€åœºç™½

    Args:
        is_first_consultation: æ˜¯å¦ä¸ºé¦–æ¬¡å’¨è¯¢
        user_name: ç”¨æˆ·ç§°å‘¼

    Returns:
        å¼€åœºç™½æ–‡æœ¬
    """
    if is_first_consultation:
        return f"""æ¬¢è¿æ¥åˆ°æ˜“å­¦å’¨è¯¢ï¼Œ{user_name}ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±ç®—å‘½å¸ˆã€‚

çœ‹åˆ°æ‚¨æä¾›çš„å‡ºç”Ÿä¿¡æ¯ï¼Œæˆ‘å·²ç»å¯¹æ‚¨çš„åŸºæœ¬å‘½æ ¼æœ‰äº†åˆæ­¥äº†è§£ã€‚åœ¨å¼€å§‹è¯¦ç»†åˆ†æä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆäº†è§£ä¸€ä¸‹æ‚¨æœ€å…³å¿ƒçš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ

æ¯”å¦‚ï¼š
- äº‹ä¸šå‘å±•å’ŒèŒåœºè¿åŠ¿
- æ„Ÿæƒ…å…³ç³»å’Œå©šå§»çŠ¶å†µ  
- è´¢è¿æŠ•èµ„å’Œç†è´¢æ–¹å‘
- å¥åº·å…»ç”Ÿå’Œç”Ÿæ´»è°ƒç†
- å­¦ä¸šè¿›ä¿®å’ŒæŠ€èƒ½æå‡

è¯·å‘Šè¯‰æˆ‘æ‚¨çš„ä¸»è¦å…³æ³¨ç‚¹ï¼Œæˆ‘ä¼šä¸ºæ‚¨è¿›è¡Œæœ‰é’ˆå¯¹æ€§çš„æ·±å…¥åˆ†æã€‚"""

    else:
        return f"""å¾ˆé«˜å…´å†æ¬¡ä¸ºæ‚¨æœåŠ¡ï¼Œ{user_name}ï¼

è®©æˆ‘å…ˆé€šè¿‡è®°å¿†ç³»ç»Ÿå›é¡¾ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰çš„äº¤æµï¼Œäº†è§£æ‚¨å…³æ³¨çš„é—®é¢˜æœ‰ä»€ä¹ˆæ–°çš„å‘å±•å’Œå˜åŒ–...

è¯·ç¨ç­‰ï¼Œæˆ‘æ­£åœ¨æ£€ç´¢æ‚¨çš„å†å²å’¨è¯¢è®°å½•ã€‚"""


def get_analysis_template() -> str:
    """è·å–å‘½ç†åˆ†ææ¨¡æ¿"""
    return """
## ğŸ“Š å‘½ç†åˆ†æ

**åŸºç¡€å‘½æ ¼**: {basic_destiny}
**äº”è¡Œç‰¹ç‚¹**: {five_elements}
**æ€§æ ¼ç‰¹è´¨**: {personality_traits}

## ğŸ”® è¿åŠ¿é¢„æµ‹

**è¿‘æœŸè¿åŠ¿** (æœªæ¥3ä¸ªæœˆ): {recent_fortune}
**å¹´åº¦è¶‹åŠ¿**: {yearly_trend}
**å…³é”®æ—¶æœŸ**: {key_periods}

## ğŸ’¡ å®ç”¨å»ºè®®

**å¼€è¿æ–¹æ³•**: {lucky_methods}
**æ³¨æ„äº‹é¡¹**: {precautions}
**é¢œè‰²å»ºè®®**: {lucky_colors}
**æ–¹ä½æŒ‡å¯¼**: {lucky_directions}

## ğŸ¯ é’ˆå¯¹æ€§æŒ‡å¯¼

{specific_guidance}
"""


def format_memory_context(memories: str, context_type: str = "general") -> str:
    """æ ¼å¼åŒ–è®°å¿†ä¸Šä¸‹æ–‡ç”¨äºæç¤ºï¼ŒåŸºäº MemU æœ€ä½³å®è·µä¼˜åŒ–

    Args:
        memories: åŸå§‹è®°å¿†æ–‡æœ¬
        context_type: ä¸Šä¸‹æ–‡ç±»å‹ (general|trend|insight|validation)

    Returns:
        æ ¼å¼åŒ–åçš„è®°å¿†ä¸Šä¸‹æ–‡
    """
    if not memories or memories == "æš‚æ— ç›¸å…³å†å²è®°å¿†ã€‚":
        return ""

    context_headers = {
        "general": "ğŸ“‹ å†å²å’¨è¯¢è®°å½•",
        "trend": "ğŸ“ˆ è¶‹åŠ¿åˆ†æä¸Šä¸‹æ–‡",
        "insight": "ğŸ” æ·±åº¦æ´å¯ŸèƒŒæ™¯",
        "validation": "âœ”ï¸ å†å²éªŒè¯å‚è€ƒ"
    }
    
    context_instructions = {
        "general": "è¯·åŸºäºä»¥ä¸Šå†å²ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·æä¾›è¿è´¯æ€§å’Œä¸ªæ€§åŒ–çš„å’¨è¯¢æœåŠ¡ã€‚",
        "trend": "è¯·å¯¹æ¯”åˆ†æå†å²å˜åŒ–ï¼Œæä¾›è¶‹åŠ¿åˆ†æå’Œæœªæ¥é¢„æµ‹ã€‚",
        "insight": "è¯·æ·±å…¥æŒ–æ˜å†å²æ¨¡å¼ï¼Œæä¾›æ´å¯Ÿå’Œè§„å¾‹åˆ†æã€‚",
        "validation": "è¯·éªŒè¯ä¹‹å‰çš„é¢„æµ‹å‡†ç¡®æ€§ï¼Œå¹¶åŸºäºå†å²è¡¨ç°è°ƒæ•´åˆ†ææ–¹æ³•ã€‚"
    }

    header = context_headers.get(context_type, context_headers["general"])
    instruction = context_instructions.get(context_type, context_instructions["general"])

    return f"""
## {header}

{memories}

**æŒ‡å¯¼åŸåˆ™**: {instruction}
**åˆ†æè¦æ±‚**: è¯·å°†å†å²ä¿¡æ¯ä¸å½“å‰é—®é¢˜æœ‰æœºç»“åˆï¼Œä¸è¦ç”Ÿç¡¬å †ç Œå†å²å†…å®¹ã€‚
"""


def get_memory_enhanced_prompt(base_prompt: str, memory_context: str, enhancement_type: str = "integrate") -> str:
    """ç”Ÿæˆè®°å¿†å¢å¼ºçš„æç¤ºï¼ŒåŸºäº MemU æœ€ä½³å®è·µ
    
    Args:
        base_prompt: åŸºç¡€æç¤ºå†…å®¹
        memory_context: è®°å¿†ä¸Šä¸‹æ–‡
        enhancement_type: å¢å¼ºç±»å‹ (integrate|compare|analyze|validate)
        
    Returns:
        å¢å¼ºåçš„æç¤ºå†…å®¹
    """
    if not memory_context:
        return base_prompt
        
    enhancement_templates = {
        "integrate": "è¦æ±‚ï¼šè¯·å°†ä»¥ä¸‹å†å²ä¿¡æ¯ä¸å½“å‰é—®é¢˜æœ‰æœºèåˆï¼Œæä¾›ä¸ªæ€§åŒ–å’¨è¯¢ã€‚",
        "compare": "è¦æ±‚ï¼šè¯·å¯¹æ¯”å†å²æƒ…å†µä¸å½“å‰é—®é¢˜ï¼Œåˆ†æå˜åŒ–è¶‹åŠ¿ã€‚",
        "analyze": "è¦æ±‚ï¼šè¯·æ·±å…¥åˆ†æå†å²æ¨¡å¼ï¼Œå‘ç°è§„å¾‹å’Œæ´å¯Ÿã€‚",
        "validate": "è¦æ±‚ï¼šè¯·éªŒè¯å†å²é¢„æµ‹çš„å‡†ç¡®æ€§ï¼Œå¹¶ä¼˜åŒ–åˆ†ææ–¹æ³•ã€‚"
    }
    
    enhancement_instruction = enhancement_templates.get(enhancement_type, enhancement_templates["integrate"])
    
    return f"""{base_prompt}

{memory_context}

{enhancement_instruction}
"""
